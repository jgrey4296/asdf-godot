#!/usr/bin/env bash
# https://asdf-vm.com/plugins/create.html#bin-install
# # Install a specified version
# install into ASDF_INSTALL_PATH
# shims will be created for anything in install_path/bin
# only place files in install path if success

set -euo pipefail

current_script_path=${BASH_SOURCE[0]}
plugin_dir=$(dirname "$(dirname "$current_script_path")")

# shellcheck source=../lib/utils.bash
source "${plugin_dir}/lib/utils.bash"

[[ "$ASDF_INSTALL_TYPE" = "version" ]] || fail "asdf-$TOOL_NAME supports release installs only"


dir_name=$(gd-extract-path)
bin_name=$(gd-bin-name)

(
    echo "* Installing into: $ASDF_INSTALL_PATH/bin"
    mkdir "${ASDF_INSTALL_PATH}/bin"
    if [[ -x "${ASDF_DOWNLOAD_PATH}/${bin_name}" ]]; then
        # Just the executable
        cp "${ASDF_DOWNLOAD_PATH}/${bin_name}" \
            "${ASDF_INSTALL_PATH}/bin/"

        ln -s "${ASDF_INSTALL_PATH}/bin/${bin_name}" \
            "${ASDF_INSTALL_PATH}/bin/${TOOL_NAME}"

        ln -s "${ASDF_INSTALL_PATH}/bin/${bin_name}" \
            "${ASDF_INSTALL_PATH}/bin/{$SIMPLE_NAME}"

    else
        # executable + rest
        cp -r "${ASDF_DOWNLOAD_PATH}/${dir_name}/"* \
            "${ASDF_INSTALL_PATH}/bin/"
        ln -s "${ASDF_DOWNLOAD_PATH}/bin/${bin_name}" \
            "${ASDF_DOWNLOAD_PATH}/bin/${TOOL_NAME}"
        ln -s "${ASDF_DOWNLOAD_PATH}/bin/${bin_name}" \
            "${ASDF_DOWNLOAD_PATH}/bin/${SIMPLE_NAME}"
    fi

    echo "* Testing Installation"
    test -x "${ASDF_INSTALL_PATH}/bin/${TOOL_NAME}" || fail "Expected $ASDF_INSTALL_PATH/bin/${TOOL_NAME} to be executable."
    echo "* $TOOL_NAME $ASDF_INSTALL_VERSION installation was successful!"

    echo "* TODO Install export templates"


) || (
    rm -rf "$ASDF_INSTALL_PATH"
    fail "An error occurred while installing $TOOL_NAME $ASDF_INSTALL_VERSION."
)


